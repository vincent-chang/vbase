name: LinuxRelease
on:
  workflow_dispatch:
  repository_dispatch:
  push:
    branches:
      - 'vbase'
    tags:
      - '**'
    paths-ignore:
      - '**.md'
      - 'tools/**'
      - '.github/workflows/**'
      - '!.github/workflows/LinuxRelease.yml'


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' || github.sha }}
  cancel-in-progress: true

env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  linux-release-x86_64:
    name: Build on ubuntu18.04 x86_64
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/vbase'
    runs-on: ubuntu-latest
    container: ubuntu:18.04
    steps:
      - uses: actions/checkout@v3
        with:
          ref: vbase
          fetch-depth: 0
      - uses: ./.github/actions/ubuntu_18_setup
        with:
          ccache: 1
      - name: Build
        shell: bash
        run: |
          make release
          mkdir -p build/vbase
          cd build
          cp release/duckdb ./vbase/
          cp release/src/libduckdb.so ./vbase/
          ldd release/duckdb |grep -v libc.so| awk '{print $3}'|awk NF|awk '{printf("cp %s vbase/\n",$0)}'|bash
          tar -czvf vbase.Linux_x86_64.tar.gz vbase
      - uses: actions/upload-artifact@v3
        with:
          name: vbase.Linux_x86_64.tar.gz
          path: |
            build/vbase.Linux_x86_64.tar.gz